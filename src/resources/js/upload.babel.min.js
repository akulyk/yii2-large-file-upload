function _instanceof(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function _classCallCheck(e,t){if(!_instanceof(e,t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var Alert=function(){"use strict";function e(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;_classCallCheck(this,e),_defineProperty(this,"_alertSuccess",void 0),_defineProperty(this,"_alertError",void 0),this._closeable=t,this._CloseTimeout=r,this._init()}return _createClass(e,[{key:"_init",value:function(){this._alertSuccess=document.querySelector(".alert-success"),this._alertError=document.querySelector(".alert-danger"),this._closeable&&(this._alertSuccess.classList.add("alert-dismissible"),this._alertError.classList.add("alert-dismissible"))}},{key:"success",value:function(e){var t=this;this._alertSuccess.querySelector(".alert-content").innerHTML=e,this._alertSuccess.classList.add("show"),this._CloseTimeout&&setTimeout(function(){t._alertSuccess.classList.remove("show")},this._CloseTimeout)}},{key:"error",value:function(e){var t=this;this._alertError.querySelector(".alert-content").innerHTML=e,this._alertError.classList.add("show"),this._CloseTimeout&&setTimeout(function(){t._alertError.classList.remove("show")},this._CloseTimeout)}}]),e}(),ProgressBar=function(){"use strict";function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;_classCallCheck(this,e),_defineProperty(this,"_bar",void 0),this._width=t,this._init()}return _createClass(e,[{key:"_init",value:function(){this._bar=document.querySelector(".progress-bar"),this._bar.style.width=this._width+"%"}},{key:"update",value:function(e){this._width=e,this._bar.style.width=this._width+"%"}}]),e}(),Uploader=function(){"use strict";function e(t){var r=t.file,i=t.chunkSize,s=t.uploadTimeout,o=t.urls;_classCallCheck(this,e),this._file=r,this._chunkSize=i,this._uploadTimeout=s,this._urls=o,this._progressBar=new ProgressBar(0),this._alert=new Alert(!1,3e3)}return _createClass(e,[{key:"upload",value:function(){var e=this;this._getFileInfo(this._file.name,this._file.size).then(function(t){if(void 0===t.pos)return e._alert.error(t.message),void console.error(t.message);!0===t.success?(e._progressBar.update(Math.floor(t.pos/e._file.size*100)),e._uploadFile(t.pos,e._file,e._chunkSize)):e._alert.error(t.message)}).catch(function(t){console.log(t),e._alert.error(t)})}},{key:"_uploadFile",value:function(e,t,r){var i=e+r+1,s=t.slice(e,i),o=new FileReader,a=this;o.onloadend=function(o){o.target.readyState===FileReader.DONE&&a._uploadChunk(t.name,t.size,s).then(function(t){var s=e+r,o=Math.floor(s/a._file.size*100);o>100&&(o=100),a._progressBar.update(o),console.log("Chunk uploaded! Progress: "+o+"%"),i<a._file.size?a._uploadFile(i,a._file,r):a._uploadFinish(a._file.name,a._file.size).then(function(e){!0===e.success?(console.log("Upload Complete!"),a._alert.success("File uploaded successfully!")):(console.error(e.message),a._alert.error(e.message))})}).catch(function(e){console.error(e),e&&a._alert.error(e),a._uploadFile(i-r-1,a._file,r)})},o.readAsDataURL(s)}},{key:"_uploadChunk",value:function(e,t,r){var i=this._prepareFormData({name:e,size:t,chunk:r});return this._fetchWithTimeout(this._urls.upload,{method:"POST",body:i},this._uploadTimeout)}},{key:"_uploadFinish",value:function(e,t){var r=this._prepareFormData({name:e,size:t});return this._fetchWithTimeout(this._urls.end,{method:"POST",body:r},this._uploadTimeout)}},{key:"_getFileInfo",value:function(e,t){var r=this._prepareFormData({name:e,size:t});return this._fetchWithTimeout(this._urls.begin,{method:"POST",body:r},this._uploadTimeout)}},{key:"_fetchWithTimeout",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3e3;return new Promise(function(i,s){fetch(e,t).then(function(e){if(200===e.status)return i(e.json());e.text().then(function(e){s(e)})}).catch(function(e){console.error(e),s(e)}),setTimeout(s,r)})}},{key:"_prepareFormData",value:function(e){var t=document.querySelector("meta[name=csrf-param]").getAttribute("content"),r=document.querySelector("meta[name=csrf-token]").getAttribute("content"),i=new FormData;for(var s in i.append(t,r),e)e.hasOwnProperty(s)&&i.append(s,e[s]);return i}}]),e}();window.onload=function(){var e=new ProgressBar(0),t=new Alert(!1,3e3),r=document.querySelector("[data-send]"),i=document.querySelector("input[data-large_file]"),s=+i.dataset.chunk_size,o=+i.dataset.upload_timeout,a={begin:i.dataset.begin_url,upload:i.dataset.upload_url,end:i.dataset.end_url};r.addEventListener("click",function(){e.update(0);var r=i.files[0];void 0!==r?new Uploader({file:r,chunkSize:s,uploadTimeout:o,urls:a}).upload():t.error("File not selected!")})};
